<!DOCTYPE html>
<html>
  <!-- To improve legilbility of HTML code I added comments and organized the structure with 
 the help of Copilot-->

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>How Much More Violent is Mexico Since You Were Born?</title>
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bulma@1.0.2/css/bulma.min.css"
    />
    <link href="style.css" rel="stylesheet" />
  </head>

  <body>
   <!-- Language Toggle -->
    <div class="language-toggle">
        <span id="lang-es" class="active" onclick="setLanguage('es')">ES</span>
        <span class="separator">|</span>
        <span id="lang-en" onclick="setLanguage('en')">EN</span>
    </div>


    <!-- Navigation Menu Toggle Button -->
    <button
      class="nav-menu-toggle"
      onclick="toggleNavMenu()"
      aria-label="Open navigation menu"
    >
      <svg
        xmlns="http://www.w3.org/2000/svg"
        viewBox="0 0 24 24"
        fill="none"
        stroke="currentColor"
        stroke-width="2"
        stroke-linecap="round"
        stroke-linejoin="round"
      >
        <line x1="3" y1="12" x2="21" y2="12"></line>
        <line x1="3" y1="6" x2="21" y2="6"></line>
        <line x1="3" y1="18" x2="21" y2="18"></line>
      </svg>
    </button>

    <!-- Navigation Menu Overlay -->
    <div class="nav-menu-overlay" onclick="toggleNavMenu()"></div>

    <!-- Navigation Menu -->
    <nav class="nav-menu">
      <h3>Jump to Section</h3>
      <button class="nav-menu-item" onclick="navigateTo('intro-section')">
        <span>üè†</span> Start
      </button>
      <button class="nav-menu-item" onclick="navigateTo('section-map')">
        <span>üó∫Ô∏è</span> Map
      </button>
      <button class="nav-menu-item" onclick="navigateTo('sources-contact')">
        <span>üì∞</span> Data and Contact
      </button>
    </nav>

    <div class="intro-section">
      <h1 data-i18n="intro.title">¬øCu√°nto M√°s Violento es M√©xico Desde que Naciste?</h1>
      <p data-i18n="intro.text">
        Mexico ha experimentado violencia constante y sostenida durante a√±os, 
        temo que esta violencia se haya normalizado, que la gente se haya 
        desensibilizado a los titulares diarios sobre otro homicidio. 
        Esto no es normal, y quiero mostrar y recordar a la gente que 
        UN homicidio es demasiado.
      </p>

      <div class="selector-box">
        <label for="year-select">When were you born?</label>
        <select id="year-select" name="year-select">
          <option value="" selected disabled>Select year</option>
          <option value="1990">1990 (or before)</option>
          <option value="1991">1991</option>
          <option value="1992">1992</option>
          <option value="1993">1993</option>
          <option value="1994">1994</option>
          <option value="1995">1995</option>
          <option value="1996">1996</option>
          <option value="1997">1997</option>
          <option value="1998">1998</option>
          <option value="1999">1999</option>
          <option value="2000">2000</option>
          <option value="2001">2001</option>
          <option value="2002">2002</option>
          <option value="2003">2003</option>
          <option value="2004">2004</option>
          <option value="2005">2005</option>
          <option value="2006">2006</option>
          <option value="2007">2007</option>
          <option value="2008">2008</option>
          <option value="2009">2009</option>
          <option value="2010">2010</option>
          <option value="2011">2011</option>
          <option value="2012">2012</option>
          <option value="2013">2013</option>
          <option value="2014">2014</option>
          <option value="2015">2015</option>
          <option value="2016">2016</option>
          <option value="2017">2017</option>
          <option value="2018">2018</option>
          <option value="2019">2019</option>
          <option value="2020">2020</option>
          <option value="2021">2021</option>
          <option value="2022">2022</option>
          <option value="2023">2023</option>
          <option value="2024">2024</option>
        </select>
        <button id="birth-continue-btn" class="continue-btn">Continue</button>
      </div>
      <p class="data-availability-note" style="font-size: 0.7rem">
        * Data available from 1990 to 2024
      </p>
    </div>

    <!-- Section 1: Birth Year -->
    <div class="scroll-section" id="section-birth">
      <div class="content-container">
        <div class="chart-side">
          <div class="chart-wrapper">
            <svg id="chart-birth"></svg>
          </div>
        </div>
        <div class="text-side">
          <div class="text-content">
            <h2 id="birth-heading">The Year You Were Born</h2>
            <p id="birth-text">
              In <span id="birth-year-text"></span>, Mexico recorded
            </p>
            <div class="stat" id="birth-stat"></div>
            <p id="birth-subtitle">
              This was the state of violence when you entered the world.
            </p>
          </div>
        </div>
      </div>
      <div
        class="scroll-indicator"
        onclick="document.getElementById('section-drugwar').scrollIntoView({behavior: 'smooth'})"
      >
        <span>Scroll to continue</span>
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M7 13l5 5 5-5M7 6l5 5 5-5" />
        </svg>
      </div>
    </div>

    <!-- Section 2: Drug War -->
    <div class="scroll-section" id="section-drugwar">
      <div class="content-container">
        <div class="chart-side">
          <div class="chart-wrapper">
            <svg id="chart-drugwar"></svg>
          </div>
        </div>
        <div class="text-side">
          <div class="text-content">
            <h2>The Drug War Begins</h2>
            <p id="drugwar-intro">
              Starting in 2006, the government launched a military crackdown on
              drug cartels. The strategy backfired catastrophically.
            </p>
            <p id="drugwar-middle">
              By 2011, homicides had exploded to unprecedented levels:
            </p>
            <div class="stat">27,213 homicides</div>
            <p id="drugwar-closing">
              This was the peak of the first wave, more than
              <span id="drugwar-increase"></span> from your birth year.
            </p>
          </div>
        </div>
      </div>
      <div
        class="scroll-indicator"
        onclick="document.getElementById('section-full').scrollIntoView({behavior: 'smooth'})"
      >
        <span>Scroll to continue</span>
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M7 13l5 5 5-5M7 6l5 5 5-5" />
        </svg>
      </div>
    </div>

    <!-- Section 3: Full Picture -->
    <div class="scroll-section" id="section-full">
      <div class="content-container">
        <div class="chart-side">
          <div class="chart-wrapper">
            <svg id="chart-cumulative"></svg>
          </div>
        </div>
        <div class="text-side">
          <div class="text-content">
            <h2>The Full Story</h2>
            <p id="full-intro">
              After a brief decline, violence surged again. 2020 became the
              deadliest year in modern Mexican history with
            </p>
            <div class="stat">36,773 homicides</div>
            <p id="full-middle">
              Today, violence remains at historically high levels. The crisis
              continues to devastate communities across Mexico.
            </p>
          </div>
        </div>
      </div>
      <div
        class="scroll-indicator"
        onclick="document.getElementById('section-cumulative').scrollIntoView({behavior: 'smooth'})"
      >
        <span>Scroll to continue</span>
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M7 13l5 5 5-5M7 6l5 5 5-5" />
        </svg>
      </div>
    </div>

    <!-- Section 4: Cumulative Deaths -->
    <div class="scroll-section" id="section-cumulative">
      <div class="content-container">
        <div class="chart-side">
          <div class="chart-wrapper">
            <svg id="chart-full"></svg>
          </div>
        </div>
        <div class="text-side">
          <div class="text-content">
            <h2>In Your Lifetime</h2>
            <p id="cumulative-intro">
              Since you were born in <span id="cumulative-year"></span>, this
              many people have been murdered in Mexico:
            </p>
            <div class="cumulative-stat" id="cumulative-total"></div>
            <p id="cumulative-note" class="cumulative-note">
              That's <span id="cumulative-daily"></span> people per day, every
              day, for your entire life.
            </p>
            <p
              style="
                margin-top: 40px;
                font-weight: 600;
                font-size: 1.3rem;
                color: #333;
              "
            >
              This is not normal. Every number represents a life lost, a family
              destroyed, a community traumatized.
            </p>
            <p
              id="full-closing"
              style="
                margin-top: 30px;
                padding-top: 30px;
                border-top: 2px solid #eee;
              "
            >
              The area in red represents your lifetime, every year since you
              were born.
            </p>
          </div>
        </div>
      </div>
      <div
        class="scroll-indicator"
        onclick="document.getElementById('section-age').scrollIntoView({behavior: 'smooth'})"
      >
        <span>Scroll to continue</span>
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M7 13l5 5 5-5M7 6l5 5 5-5" />
        </svg>
      </div>
    </div>

    <!-- Section 5: Age Analysis -->
    <div class="scroll-section" id="section-age">
      <div class="content-container">
        <div class="chart-side">
          <div class="chart-wrapper">
            <svg id="chart-age"></svg>
          </div>
        </div>
        <div class="text-side">
          <div class="text-content">
            <h2>People Like You</h2>
            <p id="age-intro">
              Violence doesn't discriminate by age, but some groups bear the
              heaviest burden.
            </p>

            <!-- Age range selector - only shown for 1990 -->
            <!-- Section code by Claude after prompt "I was thinking on maybe for those users have an option so 
                     they can select their age range (from 35 onwards, not all dataset) and then compute the 
                     cumulative from 1990 of that age range"-->
            <div
              id="age-selector-container"
              class="selector-box"
              style="display: none"
            >
              <label for="age-range-select">What's your age range?</label>
              <select id="age-range-select">
                <option value="" selected disabled>Select age range</option>
                <option value="35-39 anos">35-39</option>
                <option value="40-44 anos">40-44</option>
                <option value="45-49 anos">45-49</option>
                <option value="50-54 anos">50-54</option>
                <option value="55-59 anos">55-59</option>
                <option value="60-64 anos">60-64</option>
                <option value="65-69 anos">65-69</option>
                <option value="70-74 anos">70-74</option>
                <option value="75-79 anos">75-79</option>
                <option value="80-84 anos">80-84</option>
                <option value="85 anos y mas">85+</option>
              </select>
            </div>
            <!-- End of age range selector code -->

            <p id="age-question">
              Since you were born in <span id="age-birth-year"></span>, this
              many people in your age group have been murdered:
            </p>
            <div class="cumulative-stat" id="age-total"></div>
            <p id="age-closing" class="cumulative-note">
              That's people who were <span id="age-range-text"></span> years old
              when they died.
            </p>
          </div>
        </div>
      </div>
      <div
        class="scroll-indicator"
        onclick="document.getElementById('section-state').scrollIntoView({behavior: 'smooth'})"
      >
        <span>Scroll to continue</span>
        <svg
          xmlns="http://www.w3.org/2000/svg"
          viewBox="0 0 24 24"
          fill="none"
          stroke="currentColor"
          stroke-width="2"
          stroke-linecap="round"
          stroke-linejoin="round"
        >
          <path d="M7 13l5 5 5-5M7 6l5 5 5-5" />
        </svg>
      </div>
    </div>

    <!-- Section 6: Your State -->
    <div class="scroll-section" id="section-state">
      <div class="content-container">
        <!-- State selector -->
        <div class="state-selector-wrapper" id="state-selector-container">
          <div class="selector-box">
            <label id="state-selector-label" for="state-select"
              >Where were you born?</label
            >
            <select id="state-select" name="state-select"></select>
            <span
              id="state-loading"
              style="
                display: none;
                margin-left: 8px;
                font-size: 0.95rem;
                color: #666;
              "
              >Loading‚Ä¶</span
            >
            <button id="state-continue-btn" class="continue-btn">
              Continue
            </button>
            <button
              id="skip-state-btn"
              class="continue-btn"
              style="margin-left: 10px; display: block"
            >
              Skip
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Hidden until state selected -->
    <div class="state-content" id="state-content" style="display: none">
      <div class="chart-side">
        <div class="chart-wrapper">
          <svg id="chart-state"></svg>
        </div>
      </div>
      <div class="text-side">
        <div class="text-content">
          <h2>Your State: <span id="selected-state-name"></span></h2>
          <p>
            Since you were born in <span id="state-birth-year"></span>, your
            state has experienced:
          </p>
          <div class="stat" id="state-total"></div>
          <p id="state-comparison"></p>
          <button
            id="explore-nation-btn"
            style="
              margin-top: 30px;
              padding: 12px 24px;
              background: #3273dc;
              color: white;
              border: none;
              border-radius: 4px;
              cursor: pointer;
              font-size: 1rem;
            "
          >
            Explore the Nation ‚Üí
          </button>
        </div>
      </div>
    </div>

    <!-- Section 7: Interactive Choropleth Map -->
    <div class="scroll-section" id="section-map">
      <div
        class="content-container"
        style="flex-direction: column; max-width: 1200px"
      >
        <div
          class="text-content"
          style="text-align: center; margin-bottom: 30px"
        >
          <h2>Explore the Nation</h2>
          <p id="map-intro">
            See how violence has affected every state in Mexico from 1990 to
            2024
          </p>
        </div>

        <!-- Map and controls -->
        <div style="display: flex; gap: 40px; width: 100%">
          <!-- Left side: Map -->
          <div style="flex: 2">
            <div
              style="
                background: white;
                border-radius: 8px;
                padding: 20px;
                box-shadow: 0 2px 12px rgba(0, 0, 0, 0.1);
              "
            >
              <svg id="mexico-map" width="700" height="600"></svg>
            </div>
          </div>

          <!-- Right side: Controls and Info -->
          <div style="flex: 1">
            <div
              style="
                background: white;
                border-radius: 8px;
                padding: 30px;
                box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
              "
            >
              <h3 style="margin-top: 0">Select Period</h3>

              <!-- Year Range Display -->
              <div style="margin-bottom: 20px; text-align: center">
                <span style="font-size: 1.4rem; font-weight: 600; color: #333">
                  <span id="selected-start-year" style="color: #3273dc"
                    >1990</span
                  >
                  <span style="color: #999; margin: 0 8px">‚Üí</span>
                  <span id="selected-end-year" style="color: #e74c3c"
                    >2024</span
                  >
                </span>
              </div>

              <!-- Start Year Slider -->
              <div style="margin-bottom: 20px">
                <label
                  for="start-year-slider"
                  style="
                    font-size: 0.9rem;
                    color: #666;
                    display: block;
                    margin-bottom: 8px;
                  "
                >
                  Start Year
                </label>
                <input
                  type="range"
                  id="start-year-slider"
                  min="1990"
                  max="2024"
                  value="1990"
                  style="width: 100%; height: 6px; cursor: pointer"
                />
              </div>

              <!-- End Year Slider -->
              <div style="margin-bottom: 25px">
                <label
                  for="end-year-slider"
                  style="
                    font-size: 0.9rem;
                    color: #666;
                    display: block;
                    margin-bottom: 8px;
                  "
                >
                  End Year
                </label>
                <input
                  type="range"
                  id="end-year-slider"
                  min="1990"
                  max="2024"
                  value="2024"
                  style="width: 100%; height: 6px; cursor: pointer"
                />
              </div>

              <!-- Period Summary -->
              <div
                id="period-summary"
                style="
                  background: #f8f9fa;
                  padding: 12px;
                  border-radius: 6px;
                  margin-bottom: 25px;
                  text-align: center;
                "
              >
                <span style="font-size: 0.9rem; color: #666"
                  >Showing <span id="period-years">35</span> years of data</span
                >
              </div>

              <!-- Legend -->
              <div style="margin-bottom: 30px">
                <h4 style="margin-bottom: 15px">Cumulative Homicides</h4>
                <div id="map-legend"></div>
              </div>

              <!-- Selected State Info -->
              <div
                id="state-info"
                style="
                  padding: 20px;
                  background: #f5f5f5;
                  border-radius: 8px;
                  display: none;
                "
              >
                <h4
                  id="info-state-name"
                  style="margin-top: 0; color: #333"
                ></h4>
                <p
                  id="info-homicides"
                  style="
                    font-size: 2rem;
                    font-weight: bold;
                    color: #e74c3c;
                    margin: 10px 0;
                  "
                ></p>
                <p
                  id="info-details"
                  style="font-size: 0.95rem; color: #666"
                ></p>
              </div>
            </div>
          </div>
        </div>

        <!-- Municipalities Zoom Section -->
        <div
          id="municipalities-section"
          style="
            margin-top: 40px;
            background: white;
            border-radius: 8px;
            padding: 30px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
          "
        >
          <div
            id="municipalities-placeholder"
            style="text-align: center; color: #888; padding: 40px 20px"
          >
            <svg
              xmlns="http://www.w3.org/2000/svg"
              width="48"
              height="48"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="1.5"
              stroke-linecap="round"
              stroke-linejoin="round"
              style="margin-bottom: 15px; opacity: 0.5"
            >
              <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
              <circle cx="12" cy="10" r="3"></circle>
            </svg>
            <p style="font-size: 1.1rem; margin: 0">
              Click on a state above to see its top 5 most violent
              municipalities
            </p>
          </div>

          <div id="municipalities-content" style="display: none">
            <div
              style="
                display: flex;
                justify-content: space-between;
                align-items: center;
                margin-bottom: 25px;
              "
            >
              <h4 style="margin: 0; font-size: 1.3rem">
                Top 5 Municipalities in
                <span
                  id="municipalities-state-name"
                  style="color: #e74c3c"
                ></span>
              </h4>
              <span
                id="municipalities-period"
                style="font-size: 0.9rem; color: #666"
              ></span>
            </div>
            <div id="municipalities-chart-container">
              <svg id="municipalities-chart" width="100%" height="280"></svg>
            </div>
            <p
              id="municipalities-note"
              style="
                font-size: 0.85rem;
                color: #888;
                margin-top: 15px;
                text-align: center;
              "
            ></p>
          </div>
        </div>
      </div>
    </div>

    <div style="height: 100vh"></div>

    <script src="https://d3js.org/d3.v6.js"></script>
    <script src="translations.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', initializeLanguage);
    </script>
    <script>
        const translations = {
            en: {
                "intro.title": "How Much More Violent is Mexico Since You Were Born?",
                "intro.text": "Mexico has experienced sustained violence for years, and people have started to normalize this, desensitized to the daily headlines about another homicide. This is not normal, and I want to show and remind people that ONE homicide is too much."
            },
            es: {
                "intro.title": "¬øCu√°nto M√°s Violento es M√©xico Desde que Naciste?",
                "intro.text": "M√©xico ha experimentado violencia constante y sostenida durante a√±os, y la gente ha empezado a normalizarla, desensibilizada a los titulares diarios sobre otro homicidio. Esto no es normal, y quiero mostrar y recordar a la gente que UN homicidio es demasiado."
            }
            };

        let currentLanguage = 'es';

        function setLanguage(lang) {
            currentLanguage = lang;
            
            // Update toggle buttons
            document.getElementById('lang-en').classList.toggle('active', lang === 'en');
            document.getElementById('lang-es').classList.toggle('active', lang === 'es');
            
            // Update page title
            document.title = translations[lang]['intro.title'];
            
            // Update all static elements with data-i18n
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (translations[lang][key]) {
                el.textContent = translations[lang][key];
                }
            });
            
            // Update select options
            updateSelectOptions();
            
            // Store preference
            localStorage.setItem('preferredLanguage', lang);
            
            // RE-RUN DYNAMIC CONTENT IF USER HAS ALREADY STARTED
            if (typeof birthYear !== 'undefined' && birthYear !== null) {
                updateConditionalText();
                
                // Redraw visible charts to update labels
                if (document.getElementById('section-birth').classList.contains('visible')) {
                drawBirthChart();
                }
                if (document.getElementById('section-drugwar').classList.contains('visible')) {
                drawDrugWarChart();
                }
                if (document.getElementById('section-full').classList.contains('visible')) {
                drawCumulativeChart();
                }
                if (document.getElementById('section-cumulative').classList.contains('visible')) {
                drawFullChart();
                }
                if (document.getElementById('section-age').classList.contains('visible')) {
                drawAgeChart();
                }
            }
            }


        history.scrollRestoration = "manual";

        const homicideData = [
            { Year: 1990, Total: 14493.0 },
            { Year: 1991, Total: 15128.0 },
            { Year: 1992, Total: 16594.0 },
            { Year: 1993, Total: 16040.0 },
            { Year: 1994, Total: 15839.0 },
            { Year: 1995, Total: 15612.0 },
            { Year: 1996, Total: 14505.0 },
            { Year: 1997, Total: 13552.0 },
            { Year: 1998, Total: 13656.0 },
            { Year: 1999, Total: 12249.0 },
            { Year: 2000, Total: 10737.0 },
            { Year: 2001, Total: 10285.0 },
            { Year: 2002, Total: 10088.0 },
            { Year: 2003, Total: 10087.0 },
            { Year: 2004, Total: 9329.0 },
            { Year: 2005, Total: 9921.0 },
            { Year: 2006, Total: 10452.0 },
            { Year: 2007, Total: 8867.0 },
            { Year: 2008, Total: 14006.0 },
            { Year: 2009, Total: 19803.0 },
            { Year: 2010, Total: 25757.0 },
            { Year: 2011, Total: 27213.0 },
            { Year: 2012, Total: 25967.0 },
            { Year: 2013, Total: 23063.0 },
            { Year: 2014, Total: 20010.0 },
            { Year: 2015, Total: 20762.0 },
            { Year: 2016, Total: 24559.0 },
            { Year: 2017, Total: 32079.0 },
            { Year: 2018, Total: 36685.0 },
            { Year: 2019, Total: 36661.0 },
            { Year: 2020, Total: 36773.0 },
            { Year: 2021, Total: 35700.0 },
            { Year: 2022, Total: 33287.0 },
            { Year: 2023, Total: 32252.0 },
            { Year: 2024, Total: 33550.0 },
        ];

      const data = homicideData.map((d) => ({
        year: d.Year,
        date: new Date(d.Year, 0, 1),
        value: d.Total,
      }));

      let birthYear = null;

      let ageData = [];

      d3.csv("homicides_by_age.csv").then(function (data) {
        ageData = data.map((d) => {
          const keys = Object.keys(d);
          const result = {
            year: +d[keys[0]],
            total: +d["Total"],
          };

          // Add all age group columns
          keys.forEach((key) => {
            if (key !== keys[0] && key !== "Total") {
              result[key.trim()] = +d[key]; // trim() removes any spaces
            }
          });

          return result;
        });

        console.log("Age data loaded successfully!");
      });

      // Navigation Menu Functions
      function toggleNavMenu() {
        document.querySelector(".nav-menu").classList.toggle("open");
        document.querySelector(".nav-menu-overlay").classList.toggle("open");
      }

      function navigateTo(sectionId) {
        // Close the menu
        toggleNavMenu();

        // Handle intro section (it's a class, not an id)
        if (sectionId === "intro-section") {
          document
            .querySelector(".intro-section")
            .scrollIntoView({ behavior: "smooth" });
        } else {
          document
            .getElementById(sectionId)
            .scrollIntoView({ behavior: "smooth" });

          // Make section visible
          document.getElementById(sectionId).classList.add("visible");

          // If navigating to map, initialize it
          if (sectionId === "section-map") {
            setTimeout(() => {
              initializeMap();
            }, 1000);
          }
        }
      }

      // Setup
      document
        .getElementById("year-select")
        .addEventListener("change", function () {
          if (this.value) {
            document
              .getElementById("birth-continue-btn")
              .classList.add("visible");
          }
        });

      // State selector
      document
        .getElementById("state-select")
        .addEventListener("change", function () {
          if (this.value) {
            document
              .getElementById("state-continue-btn")
              .classList.add("visible");
          }
        });

      document
        .getElementById("state-select")
        .addEventListener("change", function () {
          if (this.value) {
            document
              .getElementById("state-continue-btn")
              .classList.add("visible");
          }
        });

      document
        .getElementById("birth-continue-btn")
        .addEventListener("click", function () {
          birthYear = +document.getElementById("year-select").value;

          console.log("Birth year:", birthYear);

          // Check if data is ready before scrolling
          if (ageData.length > 0) {
            setupScrollAnimations();
            document
              .getElementById("section-birth")
              .scrollIntoView({ behavior: "smooth" });
          } else {
            console.log("Waiting for age data to load...");
            // Wait for data, then proceed
            const checkData = setInterval(() => {
              if (ageData.length > 0) {
                clearInterval(checkData);
                setupScrollAnimations();
                document
                  .getElementById("section-birth")
                  .scrollIntoView({ behavior: "smooth" });
                console.log("Age data ready!");
              }
            }, 100);
          }
        });

      document
        .getElementById("age-range-select")
        .addEventListener("change", function () {
          if (birthYear === 1990 && this.value) {
            drawAgeChart();
          }
        });

      // Helper function to update conditional text
      function updateConditionalText() {
        // SECTION 1: BIRTH YEAR
        if (birthYear === 1990) {
          document.getElementById("birth-heading").textContent =
            "The Last 35 Years of Mexico's History";
          document.getElementById("birth-text").innerHTML =
            'During the last 35 years of Mexico\'s history:<br><br>In <span id="birth-year-text">1990</span>, Mexico recorded';
          document.getElementById("birth-subtitle").textContent =
            "This was the state of violence 35 years ago.";
        } else {
          document.getElementById("birth-heading").textContent =
            "The Year You Were Born";
          document.getElementById("birth-text").innerHTML =
            'In <span id="birth-year-text"></span>, Mexico recorded';
          document.getElementById("birth-subtitle").textContent =
            "This was the state of violence when you entered the world.";
        }

        // SECTION 4: CUMULATIVE DEATHS
        if (birthYear === 1990) {
          document.getElementById("cumulative-intro").innerHTML =
            'Since <span id="cumulative-year"></span>, when modern records began, this many people have been murdered in Mexico:';
          document.getElementById("cumulative-note").innerHTML =
            'That\'s <span id="cumulative-daily"></span> people per day, every single day, for 35 years.';
        } else if (birthYear === 2024) {
          document.getElementById("cumulative-intro").innerHTML =
            'Since you were born in <span id="cumulative-year"></span>, this many people have been murdered in Mexico:';
          document.getElementById("cumulative-note").innerHTML =
            "That's <span id=\"cumulative-daily\"></span> people per day.<br><br>In the brief moments of your life so far, violence continues at historically unprecedented levels. This is the world you've inherited.";
        }

        // SECTION 5: AGE ANALYSIS
        if (birthYear === 1990) {
          document.getElementById("age-intro").textContent =
            "Violence doesn't discriminate by age, but some groups bear the heaviest burden.";
          document.getElementById("age-question").innerHTML =
            'Since <span id="age-birth-year"></span>, this many people in your age group have been murdered:';
          document.getElementById("age-closing").innerHTML =
            'That\'s people who were <span id="age-range-text"></span> years old when they died.';
        } else if (birthYear === 2024) {
          document.getElementById("age-intro").textContent =
            "Violence doesn't discriminate by age, but some groups bear the heaviest burden.";
          document.getElementById("age-question").innerHTML =
            'Since you were born in <span id="age-birth-year"></span>, this many people in your age group have been murdered:';
          document.getElementById("age-closing").innerHTML =
            "That's people who were between 0 and 4 years old when they died.";
        }

        // SECTION 6: STATE SELECTOR LABEL
        if (birthYear === 1990) {
          document.getElementById("state-selector-label").textContent =
            "Where did you experience this violence?";
        } else {
          document.getElementById("state-selector-label").textContent =
            "Where were you born?";
        }

        // SECTION 7: MAP INTRO
        if (birthYear === 1990) {
          document.getElementById("map-intro").textContent =
            "See how violence has transformed every state in Mexico over the last 35 years‚Äîa transformation you've witnessed.";
        } else if (birthYear === 2024) {
          document.getElementById("map-intro").textContent =
            "See the violence across every state in Mexico‚Äîthe landscape of the country you were born into.";
        }
      }

      function setupScrollAnimations() {
        updateConditionalText();

        const sections = document.querySelectorAll(".scroll-section");

        const observer = new IntersectionObserver(
          (entries) => {
            entries.forEach((entry) => {
              if (entry.isIntersecting) {
                entry.target.classList.add("visible");

                // Trigger animations based on section
                if (entry.target.id === "section-birth") {
                  drawBirthChart();
                } else if (entry.target.id === "section-drugwar") {
                  drawDrugWarChart();
                } else if (entry.target.id === "section-cumulative") {
                  drawFullChart();
                } else if (entry.target.id === "section-full") {
                  drawCumulativeChart();
                } else if (entry.target.id === "section-age") {
                  drawAgeChart();
                }
              }
            });
          },
          { threshold: 0.3 }
        );

        sections.forEach((section) => observer.observe(section));
      }

      function createScales(data, width, height) {
        const x = d3
          .scaleTime()
          .domain(d3.extent(data, (d) => d.date))
          .range([0, width]);

        const y = d3
          .scaleLinear()
          .domain([0, d3.max(data, (d) => d.value)])
          .nice()
          .range([height, 0]);

        return { x, y };
      }

      function drawBirthChart() {
        d3.select("#chart-birth").selectAll("*").remove();
        const margin = { top: 20, right: 30, bottom: 40, left: 60 };
        const width = 500 - margin.left - margin.right;
        const height = 400 - margin.top - margin.bottom;

        const svg = d3
          .select("#chart-birth")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr("transform", `translate(${margin.left},${margin.top})`);

        // For pre-1990 condition, show data up to 1990; otherwise show data up to birthYear
        const chartBirthYear = birthYear === 1990 ? 1990 : birthYear;
        const filteredData = data.filter((d) => d.year <= chartBirthYear);
        const { x, y } = createScales(data, width, height);

        // Axes
        svg
          .append("g")
          .attr("transform", `translate(0,${height})`)
          .call(d3.axisBottom(x).ticks(6).tickFormat(d3.timeFormat("%Y")));

        svg
          .append("g")
          .call(d3.axisLeft(y).tickFormat((d) => d.toLocaleString()));

        // Line
        const line = d3
          .line()
          .x((d) => x(d.date))
          .y((d) => y(d.value))
          .curve(d3.curveMonotoneX);

        const path = svg
          .append("path")
          .datum(filteredData)
          .attr("fill", "none")
          .attr("stroke", "steelblue")
          .attr("stroke-width", 3)
          .attr("d", line);

        // Animate line drawing
        const totalLength = path.node().getTotalLength();
        path
          .attr("stroke-dasharray", totalLength + " " + totalLength)
          .attr("stroke-dashoffset", totalLength)
          .transition()
          .duration(1500)
          .ease(d3.easeLinear)
          .attr("stroke-dashoffset", 0);

        // Highlight end point
        const endPoint = filteredData[filteredData.length - 1];
        svg
          .append("circle")
          .attr("cx", x(endPoint.date))
          .attr("cy", y(endPoint.value))
          .attr("r", 0)
          .attr("fill", "#e74c3c")
          .transition()
          .delay(2000)
          .duration(300)
          .attr("r", 6);

        // Update text - birth-year-text span should already exist from updateConditionalText()
        const birthYearSpan = document.getElementById("birth-year-text");
        if (birthYearSpan) {
          if (birthYear === 1990) {
            birthYearSpan.textContent = "1990";
          } else {
            birthYearSpan.textContent = birthYear;
          }
        }
        document.getElementById("birth-stat").textContent =
          endPoint.value.toLocaleString() + t(" homicides");
      }

      function drawDrugWarChart() {
        d3.select("#chart-drugwar").selectAll("*").remove();
        const margin = { top: 20, right: 30, bottom: 40, left: 60 };
        const width = 500 - margin.left - margin.right;
        const height = 400 - margin.top - margin.bottom;

        const svg = d3
          .select("#chart-drugwar")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr("transform", `translate(${margin.left},${margin.top})`);

        const filteredData = data.filter((d) => d.year <= 2011);
        const { x, y } = createScales(data, width, height);

        svg
          .append("g")
          .attr("transform", `translate(0,${height})`)
          .call(d3.axisBottom(x).ticks(6).tickFormat(d3.timeFormat("%Y")));

        svg
          .append("g")
          .call(d3.axisLeft(y).tickFormat((d) => d.toLocaleString()));

        const line = d3
          .line()
          .x((d) => x(d.date))
          .y((d) => y(d.value))
          .curve(d3.curveMonotoneX);

        const path = svg
          .append("path")
          .datum(filteredData)
          .attr("fill", "none")
          .attr("stroke", "steelblue")
          .attr("stroke-width", 3)
          .attr("d", line);

        const totalLength = path.node().getTotalLength();
        path
          .attr("stroke-dasharray", totalLength + " " + totalLength)
          .attr("stroke-dashoffset", totalLength)
          .transition()
          .duration(2000)
          .ease(d3.easeLinear)
          .attr("stroke-dashoffset", 0);

        // Add vertical line for 2006 (Drug War officially declared)
        const drugWarStartDate = new Date(2006, 0, 1);
        const xPos2006 = x(drugWarStartDate);

        svg
          .append("line")
          .attr("x1", xPos2006)
          .attr("x2", xPos2006)
          .attr("y1", 0)
          .attr("y2", height)
          .attr("stroke", "#e74c3c")
          .attr("stroke-width", 2)
          .attr("stroke-dasharray", "5,5")
          .attr("opacity", 0)
          .transition()
          .delay(2000)
          .duration(500)
          .attr("opacity", 0.6);

        // Add legend label for 2006 line
        svg
          .append("text")
          .attr("x", xPos2006 + 5)
          .attr("y", 15)
          .attr("font-size", "11px")
          .attr("fill", "#e74c3c")
          .attr("font-weight", "600")
          .attr("opacity", 0)
          .text("Drug War declared (2006)")
          .transition()
          .delay(2000)
          .duration(500)
          .attr("opacity", 0.8);

        // For birth year 1990, show 1990 as reference year
        let referenceYear = birthYear;
        if (birthYear === 1990) {
          referenceYear = 1990;
        } else if (birthYear === 2024) {
          // For 2024 births, don't show anything
          return;
        }

        // Only draw point if birth year is <= 2011 (within chart range)
        if (referenceYear <= 2011) {
          const referenceData = data.find((d) => d.year === referenceYear);

          if (referenceData) {
            // Add red dot at reference year
            svg
              .append("circle")
              .attr("cx", x(referenceData.date))
              .attr("cy", y(referenceData.value))
              .attr("r", 0)
              .attr("fill", "#e74c3c")
              .transition()
              .delay(2000)
              .duration(300)
              .attr("r", 5);

            // Add label above the dot showing the reference year
            svg
              .append("text")
              .attr("x", x(referenceData.date))
              .attr("y", y(referenceData.value) - 15)
              .attr("text-anchor", "middle")
              .attr("font-size", "12px")
              .attr("font-weight", "600")
              .attr("fill", "#e74c3c")
              .attr("opacity", 0)
              .text(referenceYear)
              .transition()
              .delay(2300)
              .duration(300)
              .attr("opacity", 1);

            // Calculate and display increase
            const drugWarData = data.find((d) => d.year === 2011);
            const increase = (
              ((drugWarData.value - referenceData.value) /
                referenceData.value) *
              100
            ).toFixed(0);
            document.getElementById("drugwar-increase").textContent =
              increase + "% higher";
          }
        }
      }

      function drawFullChart() {
        let startYear = birthYear;
        if (birthYear === 1990) {
          startYear = 1990;
        }
        const dataAfterBirth = data.filter((d) => d.year >= startYear);
        const cumulativeTotal = dataAfterBirth.reduce(
          (sum, d) => sum + d.value,
          0
        );
        const years = 2024 - startYear + 1;
        const dailyAverage = Math.round(cumulativeTotal / (years * 365));

        if (birthYear === 1990) {
          document.getElementById("cumulative-year").textContent = "1990";
        } else {
          document.getElementById("cumulative-year").textContent = birthYear;
        }
        document.getElementById("cumulative-total").textContent =
          cumulativeTotal.toLocaleString();
        document.getElementById("cumulative-daily").textContent =
          dailyAverage.toLocaleString();

        d3.select("#chart-full").selectAll("*").remove();

        const margin = { top: 20, right: 30, bottom: 40, left: 60 };
        const width = 500 - margin.left - margin.right;
        const height = 400 - margin.top - margin.bottom;

        const svg = d3
          .select("#chart-full")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr("transform", `translate(${margin.left},${margin.top})`);

        const { x, y } = createScales(data, width, height);

        svg
          .append("g")
          .attr("transform", `translate(0,${height})`)
          .call(d3.axisBottom(x).ticks(6).tickFormat(d3.timeFormat("%Y")));

        svg
          .append("g")
          .call(d3.axisLeft(y).tickFormat((d) => d.toLocaleString()));

        // Determine the year to split the chart
        const splitYear = birthYear === 1990 ? 1990 : birthYear;

        // Area before split year (blue)
        const dataBefore = data.filter((d) => d.year <= splitYear);
        const areaBeforeBirth = d3
          .area()
          .x((d) => x(d.date))
          .y0(height)
          .y1((d) => y(d.value))
          .curve(d3.curveMonotoneX);

        svg
          .append("path")
          .datum(dataBefore)
          .attr("fill", "steelblue")
          .attr("opacity", 0.3)
          .attr("d", areaBeforeBirth);

        // Area after split year (red)
        const dataAfter = data.filter((d) => d.year >= splitYear);
        const areaAfterBirth = d3
          .area()
          .x((d) => x(d.date))
          .y0(height)
          .y1((d) => y(d.value))
          .curve(d3.curveMonotoneX);

        svg
          .append("path")
          .datum(dataAfter)
          .attr("fill", "#e74c3c")
          .attr("opacity", 0.5)
          .attr("d", areaAfterBirth);

        // Full line
        const line = d3
          .line()
          .x((d) => x(d.date))
          .y((d) => y(d.value))
          .curve(d3.curveMonotoneX);

        const path = svg
          .append("path")
          .datum(data)
          .attr("fill", "none")
          .attr("stroke", "#333")
          .attr("stroke-width", 3)
          .attr("d", line);

        const totalLength = path.node().getTotalLength();
        path
          .attr("stroke-dasharray", totalLength + " " + totalLength)
          .attr("stroke-dashoffset", totalLength)
          .transition()
          .duration(3000)
          .ease(d3.easeLinear)
          .attr("stroke-dashoffset", 0);

        // Add vertical line for 2006 (Drug War officially declared)
        const drugWarStartDate = new Date(2006, 0, 1);
        const xPos2006 = x(drugWarStartDate);

        svg
          .append("line")
          .attr("x1", xPos2006)
          .attr("x2", xPos2006)
          .attr("y1", 0)
          .attr("y2", height)
          .attr("stroke", "#e74c3c")
          .attr("stroke-width", 2)
          .attr("stroke-dasharray", "5,5")
          .attr("opacity", 0)
          .transition()
          .delay(3000)
          .duration(500)
          .attr("opacity", 0.6);

        // Add legend label for 2006 line
        svg
          .append("text")
          .attr("x", xPos2006 + 5)
          .attr("y", 15)
          .attr("font-size", "11px")
          .attr("fill", "#e74c3c")
          .attr("font-weight", "600")
          .attr("opacity", 0)
          .text("Drug War declared (2006)")
          .transition()
          .delay(3000)
          .duration(500)
          .attr("opacity", 0.8);

        // Add red dot at birth year (for user orientation)
        let referenceYear = birthYear;
        if (birthYear === 1990) {
          referenceYear = 1990;
        } else if (birthYear === 2024) {
          referenceYear = 2024;
        }

        const referenceData = data.find((d) => d.year === referenceYear);
        if (referenceData) {
          svg
            .append("circle")
            .attr("cx", x(referenceData.date))
            .attr("cy", y(referenceData.value))
            .attr("r", 0)
            .attr("fill", "#e74c3c")
            .transition()
            .delay(3000)
            .duration(300)
            .attr("r", 5);

          // Add label above the dot showing the reference year
          svg
            .append("text")
            .attr("x", x(referenceData.date))
            .attr("y", y(referenceData.value) - 15)
            .attr("text-anchor", "middle")
            .attr("font-size", "12px")
            .attr("font-weight", "600")
            .attr("fill", "#e74c3c")
            .attr("opacity", 0)
            .text(referenceYear)
            .transition()
            .delay(3300)
            .duration(300)
            .attr("opacity", 1);
        }
      }

      function drawCumulativeChart() {
        // Calculate cumulative total based on birth year condition
        let startYear = birthYear;
        if (birthYear === 1990) {
          startYear = 1990;
        }

        const dataAfterBirth = data.filter((d) => d.year >= startYear);
        const cumulativeTotal = dataAfterBirth.reduce(
          (sum, d) => sum + d.value,
          0
        );
        const years = 2024 - startYear + 1;
        const dailyAverage = Math.round(cumulativeTotal / (years * 365));

        // Draw cumulative bar chart - NOW SHOWING ALL YEARS
        d3.select("#chart-cumulative").selectAll("*").remove();
        const margin = { top: 20, right: 30, bottom: 60, left: 60 };
        const width = 500 - margin.left - margin.right;
        const height = 400 - margin.top - margin.bottom;

        const svg = d3
          .select("#chart-cumulative")
          .attr("width", width + margin.left + margin.right)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr("transform", `translate(${margin.left},${margin.top})`);

        // Use ALL data, not just dataAfterBirth
        const x = d3
          .scaleBand()
          .domain(data.map((d) => d.year))
          .range([0, width])
          .padding(0.1);

        const y = d3
          .scaleLinear()
          .domain([0, d3.max(data, (d) => d.value)])
          .nice()
          .range([height, 0]);

        svg
          .append("g")
          .attr("transform", `translate(0,${height})`)
          .call(
            d3
              .axisBottom(x)
              .tickValues(x.domain().filter((d, i) => i % 5 === 0))
          );

        svg
          .append("g")
          .call(d3.axisLeft(y).tickFormat((d) => d.toLocaleString()));

        // Draw bars with color based on birth year
        svg
          .selectAll(".bar")
          .data(data)
          .enter()
          .append("rect")
          .attr("class", "bar")
          .attr("x", (d) => x(d.year))
          .attr("y", height)
          .attr("width", x.bandwidth())
          .attr("height", 0)
          .attr("fill", (d) => {
            if (d.year === 2020) return "#8B0000";
            if (d.year === birthYear) return "#2c3e50"; // Dark color for birth year
            if (birthYear === 1990) return "#e74c3c"; // All red if born 1990 or before
            if (d.year >= birthYear) return "#e74c3c"; // Red for years after birth
            return "#bdc3c7"; // Gray for years before birth
          })
          .transition()
          .duration(1500)
          .delay((d, i) => i * 30)
          .attr("y", (d) => y(d.value))
          .attr("height", (d) => height - y(d.value));

        // Add a label for birth year bar
        // Add a label for birth year bar (only if birth year is in the data range)
        const birthYearData = data.find((d) => d.year === birthYear);
        if (birthYearData) {
          svg
            .append("text")
            .attr("x", x(birthYear) + x.bandwidth() / 2)
            .attr("y", y(birthYearData.value) - 8)
            .attr("text-anchor", "middle")
            .attr("font-size", "11px")
            .attr("font-weight", "600")
            .attr("fill", "#2c3e50")
            .attr("opacity", 0)
            .text(birthYear === 1990 ? "1990" : "You")
            .transition()
            .delay(1800)
            .duration(300)
            .attr("opacity", 1);
        }

        const year2020Data = data.find((d) => d.year === 2020);
        if (year2020Data) {
          svg
            .append("text")
            .attr("x", x(2020) + x.bandwidth() / 2)
            .attr("y", y(year2020Data.value) - 8)
            .attr("text-anchor", "middle")
            .attr("font-size", "11px")
            .attr("font-weight", "600")
            .attr("fill", "#8B0000")
            .attr("opacity", 0)
            .text("Deadliest (2020)")
            .transition()
            .delay(1800)
            .duration(300)
            .attr("opacity", 1);
        }
      }

      function getCurrentAgeGroup(birthYear) {
        const currentAge = 2024 - birthYear + 1;

        if (currentAge >= 0 && currentAge <= 4) return "0-4 anos";
        if (currentAge >= 5 && currentAge <= 9) return "5-9 anos";
        if (currentAge >= 10 && currentAge <= 14) return "10-14 anos";
        if (currentAge >= 15 && currentAge <= 19) return "15-19 anos";
        if (currentAge >= 20 && currentAge <= 24) return "20-24 anos";
        if (currentAge >= 25 && currentAge <= 29) return "25-29 anos";
        if (currentAge >= 30 && currentAge <= 34) return "30-34 anos";
        if (currentAge >= 35 && currentAge <= 39) return "35-39 anos";
        if (currentAge >= 40 && currentAge <= 44) return "40-44 anos";
        if (currentAge >= 45 && currentAge <= 49) return "45-49 anos";
        if (currentAge >= 50 && currentAge <= 54) return "50-54 anos";
        if (currentAge >= 55 && currentAge <= 59) return "55-59 anos";
        if (currentAge >= 60 && currentAge <= 64) return "60-64 anos";
        if (currentAge >= 65 && currentAge <= 69) return "65-69 anos";
        if (currentAge >= 70 && currentAge <= 74) return "70-74 anos";
        if (currentAge >= 75 && currentAge <= 79) return "75-79 anos";
        if (currentAge >= 80 && currentAge <= 84) return "80-84 anos";
        if (currentAge >= 85) return "85 anos y mas";
      }

      function calculateAgeGroupDeaths(birthYear) {
        const ageGroup = getCurrentAgeGroup(birthYear);

        console.log("Looking for age group:", ageGroup);

        // Filter data from birthYear onwards
        const relevantData = ageData.filter((d) => d.year >= birthYear);

        // Sum up deaths in that age group
        const total = relevantData.reduce(
          (sum, d) => sum + (d[ageGroup] || 0),
          0
        );

        // Also return yearly breakdown for the chart
        const yearlyData = relevantData.map((d) => ({
          year: d.year,
          deaths: d[ageGroup] || 0,
        }));

        return { total, yearlyData, ageGroup };
      }

      function drawAgeChart() {
        // For 1990, show selector and wait for user input
        // Funciton created by Claude when asked about modifyng chart with age group selector
        if (birthYear === 1990) {
          document.getElementById("age-selector-container").style.display =
            "block";
          document.getElementById("age-birth-year").textContent = "1990";

          // Check if user already selected an age range
          const selectedAgeRange =
            document.getElementById("age-range-select").value;
          if (!selectedAgeRange) {
            // Show placeholder until they select
            document.getElementById("age-total").textContent = "‚Äî";
            // Fixed made by Claude after prompting my error message
            const ageRangeTextElement = document.getElementById("age-range-text");
            if (ageRangeTextElement) {
              ageRangeTextElement.textContent = "...";
            }
            d3.select("#chart-age").selectAll("*").remove();
            return;
          }

          // Use the selected age range
          drawAgeChartWithGroup(selectedAgeRange, 1990);
        } else {
          // Hide selector for other years
          document.getElementById("age-selector-container").style.display =
            "none";

          if (birthYear === 2024) {
            document.getElementById("age-birth-year").textContent = "2024";
            drawAgeChartWithGroup("0-4 anos", 2024);
          } else {
            const ageGroup = getCurrentAgeGroup(birthYear);
            document.getElementById("age-birth-year").textContent = birthYear;
            drawAgeChartWithGroup(ageGroup, birthYear);
          }
        }
      }

      function drawAgeChartWithGroup(ageGroup, startYear) {
        // Funciton created by Claude when asked about modifyng chart with age group selector
        // Filter data from startYear onwards
        const relevantData = ageData.filter((d) => d.year >= startYear);

        // Sum up deaths in that age group
        const total = relevantData.reduce(
          (sum, d) => sum + (d[ageGroup] || 0),
          0
        );

        // Extract age range for display
        let ageRangeDisplay;
        if (ageGroup === "85 anos y mas") {
          ageRangeDisplay = "85+";
        } else {
          const ageRangeMatch = ageGroup.match(/(\d+-\d+)/);
          ageRangeDisplay = ageRangeMatch ? ageRangeMatch[1] : ageGroup;
        }

        // Update text elements
        // Fixed made by Claude after prompting my error message
        document.getElementById("age-total").textContent =
          total.toLocaleString();
        const ageRangeTextElement = document.getElementById("age-range-text");
        if (ageRangeTextElement) {
          ageRangeTextElement.textContent = ageRangeDisplay;
        }

        // How many people each silhouette represents
        const PEOPLE_PER_ICON = 500;
        const fullIcons = Math.floor(total / PEOPLE_PER_ICON);
        const remainder = total % PEOPLE_PER_ICON;
        const partialOpacity = remainder / PEOPLE_PER_ICON; // Percentage for partial icon
        const totalIcons = remainder > 0 ? fullIcons + 1 : fullIcons;

        console.log(
          `Creating ${fullIcons} full silhouettes + ${
            remainder > 0 ? "1 partial" : "no partial"
          } (${PEOPLE_PER_ICON} people each)`
        );

        // Clear any existing content
        d3.select("#chart-age").selectAll("*").remove();

        // Container dimensions
        const containerWidth = 500;
        const containerHeight = 400;
        const iconSize = 20;
        const iconSpacing = 5;

        const iconsPerRow = Math.floor(
          containerWidth / (iconSize + iconSpacing)
        );
        const numRows = Math.ceil(totalIcons / iconsPerRow);

        const svg = d3
          .select("#chart-age")
          .attr("width", containerWidth)
          .attr("height", containerHeight)
          .attr("viewBox", `0 0 ${containerWidth} ${containerHeight}`);

        // Create silhouette data array
        const silhouettes = [];
        for (let i = 0; i < totalIcons; i++) {
          const row = Math.floor(i / iconsPerRow);
          const col = i % iconsPerRow;
          silhouettes.push({
            x: col * (iconSize + iconSpacing) + iconSize / 2,
            y: row * (iconSize + iconSpacing) + iconSize / 2,
            index: i,
            isPartial: i === totalIcons - 1 && remainder > 0,
            finalOpacity:
              i === totalIcons - 1 && remainder > 0
                ? partialOpacity * 0.7
                : 0.7,
          });
        }

        // Draw silhouettes
        svg
          .selectAll(".silhouette")
          .data(silhouettes)
          .enter()
          .append("path")
          .attr("class", "silhouette")
          .attr(
            "d",
            "M12 12c2.21 0 4-1.79 4-4s-1.79-4-4-4-4 1.79-4 4 1.79 4 4 4zm0 2c-2.67 0-8 1.34-8 4v2h16v-2c0-2.66-5.33-4-8-4z"
          )
          .attr(
            "transform",
            (d) => `translate(${d.x - 12}, ${d.y - 12}) scale(${iconSize / 24})`
          )
          .attr("fill", "#e74c3c")
          .attr("opacity", 0)
          .transition()
          .duration(30)
          .delay((d) => d.index * 10)
          .attr("opacity", (d) => d.finalOpacity);

        // Add legend
        svg
          .append("text")
          .attr("x", containerWidth / 2)
          .attr("y", containerHeight - 10)
          .attr("text-anchor", "middle")
          .attr("font-size", "11px")
          .attr("fill", "#666")
          .style("font-style", "italic")
          .text(
            "* Each silhouette represents " +
              PEOPLE_PER_ICON.toLocaleString() +
              " people"
          );
      }

      let stateData = [];
      let municipalityData = [];

      // Reference to the D3 selection of state paths on the map
      let mapStates = null;

      // Map year range variables
      let mapStartYear = 1990;
      let mapEndYear = 2024;

      // Return cumulative homicides for a normalized state name within a year range
      function getStateCumulative(normalizedState, fromYear, toYear) {
        if (!stateData || stateData.length === 0) return 0;
        return stateData
          .filter(
            (s) =>
              normalizeStateName(s.state) === normalizedState &&
              s.year >= fromYear &&
              s.year <= toYear
          )
          .reduce((sum, s) => sum + (isNaN(s.homicides) ? 0 : s.homicides), 0);
      }

      // Show loading indicator while state CSV is fetched
      if (document.getElementById("state-loading"))
        document.getElementById("state-loading").style.display = "inline-block";
      let stateOptions = [];
      d3.csv("homicides_locations_tidy.csv").then(function (data) {
        // Separate state and municipality data
        stateData = data
          .filter((d) => d.Type == "state")
          .map((d) => ({
            year: +d.Year,
            state: d.State,
            homicides: +d.Homicides,
          }));

        municipalityData = data
          .filter(
            (d) =>
              d.Type == "municipality" && d.Municipality !== "No especificado"
          )
          .map((d) => ({
            year: +d.Year,
            state: d.State,
            municipality: d.Municipality,
            homicides: +d.Homicides,
          }));

        console.log("State data loaded successfully");
        console.log(
          "Municipality data loaded:",
          municipalityData.length,
          "records"
        );
        console.log(
          "States found:",
          [...new Set(stateData.map((d) => d.state))].sort()
        );
        console.log("Sample municipality data:", municipalityData.slice(0, 5));
        // Populate the state dropdown so options match the CSV data

        // All the above until get the top municipalities was built with the help
        // of Claude AI, after prompt "My States dropdown is not populating correctly in the map.
        // I have problems with states like "Estado de M√©xico" that appear as "Mexico" in the JSON.
        // Can you help me fix the code to normalize the state names between both datasets?"

        populateStateDropdown();
        // Hide loading indicator and show search box
        if (document.getElementById("state-loading"))
          document.getElementById("state-loading").style.display = "none";
        if (document.getElementById("state-search"))
          document.getElementById("state-search").style.display = "block";
      });

      function populateStateDropdown() {
        // Get unique, normalized states from stateData, sorted alphabetically
        const states = [
          ...new Set(stateData.map((d) => normalizeStateName(d.state))),
        ]
          .filter((s) => s && s !== "Extranjero")
          .sort();

        // store normalized list for filtering
        stateOptions = states;

        const dropdown = document.getElementById("state-select");

        renderStateOptions(states);

        console.log(`Populated dropdown with ${states.length} states`);
      }

      function renderStateOptions(statesArray) {
        const dropdown = document.getElementById("state-select");
        if (!dropdown) return;
        dropdown.innerHTML = "";
        const defaultOpt = document.createElement("option");
        defaultOpt.value = "";
        defaultOpt.disabled = true;
        defaultOpt.selected = true;
        defaultOpt.textContent = "Select State";
        dropdown.appendChild(defaultOpt);
        statesArray.forEach((state) => {
          const option = document.createElement("option");
          // Use normalized state name for both value and label
          const normalized = normalizeStateName(state);
          option.value = normalized;
          option.textContent = normalized;
          dropdown.appendChild(option);
        });
      }

      let userState = null;
      document
        .getElementById("state-continue-btn")
        .addEventListener("click", function () {
          const selectedState = document.getElementById("state-select").value;
          if (!selectedState) return;

          // Store selected state globally
          userState = selectedState;

          // Scroll to map section
          document
            .getElementById("section-map")
            .scrollIntoView({ behavior: "smooth" });

          // Initialize map after scroll animation
          setTimeout(() => {
            initializeMap();
          }, 1000);
        });

      // Skip button - go directly to map without selecting a state
      document
        .getElementById("skip-state-btn")
        .addEventListener("click", function () {
          // Don't set userState, just go to map
          userState = null;

          // Scroll to map section
          document
            .getElementById("section-map")
            .scrollIntoView({ behavior: "smooth" });

          // Initialize map after scroll animation
          setTimeout(() => {
            initializeMap();
          }, 1000);
        });

      function normalizeStateName(geoJsonName) {
        // Map GeoJSON state names to data state names
        const nameMap = {
          Coahuila: "Coahuila de Zaragoza",
          Michoac√°n: "Michoac√°n de Ocampo",
          Veracruz: "Veracruz de Ignacio de la Llave",
          M√©xico: "Estado de M√©xico",
          "State of Mexico": "Estado de M√©xico",
          "Mexico City": "Ciudad de M√©xico",
        };

        return nameMap[geoJsonName] || geoJsonName;
      }

      function updatePeriodDisplay() {
        document.getElementById("selected-start-year").textContent =
          mapStartYear;
        document.getElementById("selected-end-year").textContent = mapEndYear;
        document.getElementById("period-years").textContent =
          mapEndYear - mapStartYear + 1;
      }

      function initializeMap() {
        const width = 700;
        const height = 600;

        const svg = d3.select("#mexico-map");
        svg.selectAll("*").remove(); // Clear any existing content

        const g = svg.append("g");

        // Create tooltip
        const tooltip = d3
          .select("body")
          .append("div")
          .attr("class", "map-tooltip")
          .style("position", "absolute")
          .style("padding", "10px")
          .style("background", "white")
          .style("border", "1px solid #ddd")
          .style("border-radius", "4px")
          .style("pointer-events", "none")
          .style("opacity", 0)
          .style("z-index", 1000);

        // Load GeoJSON and state data
        Promise.all([
          d3.json(
            "https://raw.githubusercontent.com/angelnmara/geojson/master/mexicoHigh.json"
          ),
          Promise.resolve(stateData),
        ]).then(([geojson, data]) => {
          // Create projection
          const projection = d3.geoMercator().fitSize([width, height], geojson);

          const path = d3.geoPath().projection(projection);

          // Helper to compute max cumulative for the selected year range across states
          function computeMaxCumulative(fromYear, toYear) {
            const statesList = [
              ...new Set(data.map((d) => normalizeStateName(d.state))),
            ];
            const vals = statesList.map(
              (s) => getStateCumulative(s, fromYear, toYear) || 0
            );
            return d3.max(vals) || 1;
          }

          // Color scale based on cumulative totals
          let maxCum = computeMaxCumulative(mapStartYear, mapEndYear);
          const colorScale = d3
            .scaleSequential(d3.interpolateReds)
            .domain([0, maxCum]);

          // Draw states (store selection in `mapStates` so other functions can access it)
          mapStates = g
            .selectAll("path")
            .data(geojson.features)
            .enter()
            .append("path")
            .attr("d", path)
            .attr("fill", (d) => {
              const stateKey = normalizeStateName(d.properties.name);
              const cum = getStateCumulative(
                stateKey,
                mapStartYear,
                mapEndYear
              );
              return cum ? colorScale(cum) : "#ccc";
            })
            .attr("stroke", "#fff")
            .attr("stroke-width", 1)
            .on("mouseover", function (event, d) {
              const stateKey = normalizeStateName(d.properties.name);
              const cum = getStateCumulative(
                stateKey,
                mapStartYear,
                mapEndYear
              );

              d3.select(this).attr("stroke", "#333").attr("stroke-width", 2);

              tooltip.transition().duration(200).style("opacity", 1);
              tooltip
                .html(
                  `
                            <strong>${stateKey}</strong><br/>
                            ${
                              cum
                                ? cum.toLocaleString() + " homicides"
                                : "No data"
                            }<br/>
                            <small style="color: #666;">${mapStartYear} ‚Äì ${mapEndYear}</small>
                        `
                )
                .style("left", event.pageX + 10 + "px")
                .style("top", event.pageY - 28 + "px");
            })
            .on("mouseout", function () {
              d3.select(this).attr("stroke", "#fff").attr("stroke-width", 1);

              tooltip.transition().duration(200).style("opacity", 0);
            })
            .on("click", function (event, d) {
              const stateKey = normalizeStateName(d.properties.name);
              showStateInfo(stateKey, mapStartYear, mapEndYear);
            });

          // If user selected a state, highlight it
          if (userState && mapStates) {
            const normalizedUser = normalizeStateName(userState);
            const selectedFeature = geojson.features.find(
              (f) => normalizeStateName(f.properties.name) === normalizedUser
            );

            if (selectedFeature) {
              // Highlight selected state
              mapStates
                .filter(
                  (d) =>
                    normalizeStateName(d.properties.name) === normalizedUser
                )
                .attr("stroke", "#e74c3c")
                .attr("stroke-width", 3);

              // Show info for selected state
              showStateInfo(userState, mapStartYear, mapEndYear);
            }
          }

          // Function to update the map colors
          function updateMapColors() {
            maxCum = computeMaxCumulative(mapStartYear, mapEndYear);
            colorScale.domain([0, maxCum || 1]);

            if (mapStates) {
              mapStates
                .transition()
                .duration(300)
                .attr("fill", (d) => {
                  const stateKey = normalizeStateName(d.properties.name);
                  const cum = getStateCumulative(
                    stateKey,
                    mapStartYear,
                    mapEndYear
                  );
                  return cum ? colorScale(cum) : "#ccc";
                });
            }

            // Update legend
            createLegend(colorScale);

            // Update period display
            updatePeriodDisplay();

            // Update state info if one is selected
            const stateInfoEl = document.getElementById("state-info");
            if (stateInfoEl.style.display !== "none") {
              const currentStateName =
                document.getElementById("info-state-name").textContent;
              if (currentStateName) {
                showStateInfo(currentStateName, mapStartYear, mapEndYear);
              }
            }
          }

          // Start year slider event
          document
            .getElementById("start-year-slider")
            .addEventListener("input", function () {
              mapStartYear = +this.value;

              // Ensure start doesn't exceed end
              if (mapStartYear > mapEndYear) {
                mapStartYear = mapEndYear;
                this.value = mapStartYear;
              }

              updateMapColors();
            });

          // End year slider event
          document
            .getElementById("end-year-slider")
            .addEventListener("input", function () {
              mapEndYear = +this.value;

              // Ensure end doesn't go below start
              if (mapEndYear < mapStartYear) {
                mapEndYear = mapStartYear;
                this.value = mapEndYear;
              }

              updateMapColors();
            });

          // Create initial legend
          createLegend(colorScale);

          // Update initial period display
          updatePeriodDisplay();
        });
      }

      function showStateInfo(stateName, fromYear, toYear) {
        console.log("Looking for:", stateName, fromYear, "-", toYear);

        // Normalize for consistency (for map display)
        const normalizedState = normalizeStateName(stateName);

        // Find the original state name in the CSV data (for municipality lookup)
        // We need to check what state names exist in municipalityData that match our normalized name
        const matchingStates = [
          ...new Set(municipalityData.map((d) => d.state)),
        ].filter((s) => normalizeStateName(s) === normalizedState);
        const originalStateName =
          matchingStates.length > 0 ? matchingStates[0] : stateName;

        console.log("Normalized state:", normalizedState);

        // Reset all outlines (if map has been initialized)
        if (mapStates) {
          mapStates.attr("stroke", "#fff").attr("stroke-width", 1);

          // Highlight the selected state
          mapStates
            .filter(
              (d) => normalizeStateName(d.properties.name) === normalizedState
            )
            .attr("stroke", "#008000")
            .attr("stroke-width", 3);
        }

        // Compute cumulative homicides for the selected year range
        const cumulativeTotal = getStateCumulative(
          normalizedState,
          fromYear,
          toYear
        );

        if (!isNaN(cumulativeTotal) && cumulativeTotal > 0) {
          document.getElementById("state-info").style.display = "block";
          document.getElementById("info-state-name").textContent =
            normalizedState;
          document.getElementById("info-homicides").textContent =
            cumulativeTotal.toLocaleString();
          document.getElementById(
            "info-details"
          ).textContent = `Homicides from ${fromYear} to ${toYear}`;

          // Draw municipalities chart using the original state name from CSV
          drawMunicipalitiesChart(
            originalStateName,
            normalizedState,
            fromYear,
            toYear
          );
        } else {
          console.log(
            "No cumulative data found for ",
            normalizedState,
            fromYear,
            "-",
            toYear
          );
        }
      }

      function createLegend(colorScale) {
        // Clear any existing legend content
        const legendContainer = d3.select("#map-legend");
        legendContainer.selectAll("*").remove();

        const legendSvg = legendContainer
          .append("svg")
          .attr("width", 200)
          .attr("height", 100);

        const legend = legendSvg.append("g");

        // Dynamic legend stops based on current scale
        const maxVal = colorScale.domain()[1];
        const legendStops = [
          0,
          maxVal * 0.25,
          maxVal * 0.5,
          maxVal * 0.75,
          maxVal,
        ].map(Math.round);

        legendStops.forEach((stop, i) => {
          legend
            .append("rect")
            .attr("x", 0)
            .attr("y", i * 20)
            .attr("width", 20)
            .attr("height", 20)
            .attr("fill", colorScale(stop));

          legend
            .append("text")
            .attr("x", 25)
            .attr("y", i * 20 + 14)
            .text(stop.toLocaleString())
            .style("font-size", "12px");
        });
      }

      // Get top 5 municipalities for a state within a year range
      function getTopMunicipalities(stateName, fromYear, toYear, topN = 5) {
        if (!municipalityData || municipalityData.length === 0) return [];

        // Filter by state and year range
        const filtered = municipalityData.filter(
          (d) => d.state === stateName && d.year >= fromYear && d.year <= toYear
        );

        // Group by municipality and sum homicides
        const municipalityTotals = {};
        filtered.forEach((d) => {
          if (!municipalityTotals[d.municipality]) {
            municipalityTotals[d.municipality] = 0;
          }
          municipalityTotals[d.municipality] += d.homicides || 0;
        });

        // Convert to array and sort
        const sorted = Object.entries(municipalityTotals)
          .map(([name, total]) => ({ name, total }))
          .filter((d) => d.total > 0)
          .sort((a, b) => b.total - a.total)
          .slice(0, topN);

        return sorted;
      }

      // Draw the municipalities bar chart
      // originalStateName: the name as it appears in the CSV (for data lookup)
      // displayStateName: the normalized name for display purposes
      function drawMunicipalitiesChart(
        originalStateName,
        displayStateName,
        fromYear,
        toYear
      ) {
        const topMunicipalities = getTopMunicipalities(
          originalStateName,
          fromYear,
          toYear
        );

        console.log("Drawing municipalities for:", originalStateName);
        console.log("Top municipalities found:", topMunicipalities);

        // Show/hide appropriate elements
        document.getElementById("municipalities-placeholder").style.display =
          "none";
        document.getElementById("municipalities-content").style.display =
          "block";

        // Update header with display name
        document.getElementById("municipalities-state-name").textContent =
          displayStateName;
        document.getElementById(
          "municipalities-period"
        ).textContent = `${fromYear} ‚Äì ${toYear}`;

        // Handle case with no data
        if (topMunicipalities.length === 0) {
          document.getElementById("municipalities-note").textContent =
            "No municipality data available for this state and period.";
          d3.select("#municipalities-chart").selectAll("*").remove();
          return;
        }

        // Calculate total for percentage using the SAME original state name for consistency
        // Sum municipality data for this state to get accurate total
        const stateMunicipalityTotal = municipalityData
          .filter(
            (d) =>
              d.state === originalStateName &&
              d.year >= fromYear &&
              d.year <= toYear
          )
          .reduce((sum, d) => sum + (d.homicides || 0), 0);

        const top5Total = topMunicipalities.reduce(
          (sum, d) => sum + d.total,
          0
        );
        const percentage =
          stateMunicipalityTotal > 0
            ? ((top5Total / stateMunicipalityTotal) * 100).toFixed(1)
            : 0;

        document.getElementById(
          "municipalities-note"
        ).textContent = `These 5 municipalities account for ${percentage}% of all homicides in ${displayStateName} during this period.`;

        // Draw the chart
        const container = document.getElementById(
          "municipalities-chart-container"
        );
        const containerWidth = container.offsetWidth || 700;

        const margin = { top: 20, right: 80, bottom: 20, left: 220 };
        const width = containerWidth - margin.left - margin.right;
        const height = 250 - margin.top - margin.bottom;

        // Clear previous chart
        d3.select("#municipalities-chart").selectAll("*").remove();

        const svg = d3
          .select("#municipalities-chart")
          .attr("width", containerWidth)
          .attr("height", height + margin.top + margin.bottom)
          .append("g")
          .attr("transform", `translate(${margin.left},${margin.top})`);

        // Scales
        const x = d3
          .scaleLinear()
          .domain([0, d3.max(topMunicipalities, (d) => d.total)])
          .range([0, width]);

        const y = d3
          .scaleBand()
          .domain(topMunicipalities.map((d) => d.name))
          .range([0, height])
          .padding(0.3);

        // Bars
        svg
          .selectAll(".bar")
          .data(topMunicipalities)
          .enter()
          .append("rect")
          .attr("class", "bar")
          .attr("x", 0)
          .attr("y", (d) => y(d.name))
          .attr("width", 0)
          .attr("height", y.bandwidth())
          .attr("fill", "#e74c3c")
          .attr("rx", 4)
          .transition()
          .duration(800)
          .delay((d, i) => i * 100)
          .attr("width", (d) => x(d.total));

        // Municipality names (left side)
        svg
          .selectAll(".label")
          .data(topMunicipalities)
          .enter()
          .append("text")
          .attr("class", "label")
          .attr("x", -10)
          .attr("y", (d) => y(d.name) + y.bandwidth() / 2)
          .attr("dy", "0.35em")
          .attr("text-anchor", "end")
          .style("font-size", "13px")
          .style("fill", "#333")
          .text((d) =>
            d.name.length > 22 ? d.name.substring(0, 20) + "..." : d.name
          );

        // Values (on the bars)
        svg
          .selectAll(".value")
          .data(topMunicipalities)
          .enter()
          .append("text")
          .attr("class", "value")
          .attr("x", (d) => x(d.total) + 8)
          .attr("y", (d) => y(d.name) + y.bandwidth() / 2)
          .attr("dy", "0.35em")
          .style("font-size", "12px")
          .style("font-weight", "600")
          .style("fill", "#666")
          .style("opacity", 0)
          .text((d) => d.total.toLocaleString())
          .transition()
          .duration(400)
          .delay((d, i) => 800 + i * 100)
          .style("opacity", 1);

        // Rank numbers
        svg
          .selectAll(".rank")
          .data(topMunicipalities)
          .enter()
          .append("text")
          .attr("class", "rank")
          .attr("x", -margin.left + 10)
          .attr("y", (d) => y(d.name) + y.bandwidth() / 2)
          .attr("dy", "0.35em")
          .style("font-size", "14px")
          .style("font-weight", "700")
          .style("fill", "#e74c3c")
          .text((d, i) => `#${i + 1}`);
      }
    </script>
    <!-- Footer Ribbon Section -->
    <footer class="footer-ribbon" id="sources-contact">
      <div class="footer-content">
        <div class="footer-section">
          <h3>Data Source</h3>
          <p>
            <a 
              href="https://www.inegi.org.mx/sistemas/olap/proyectos/bd/continuas/mortalidad/defuncioneshom.asp?s=est#" 
              target="_blank" 
              rel="noopener noreferrer"
            >
              INEGI - Estad√≠sticas de Mortalidad
            </a>
          </p>
          <p class="footer-note">Instituto Nacional de Estad√≠stica y Geograf√≠a</p>
        </div>
        
        <div class="footer-section">
          <h3>Project</h3>
          <p>
            <a 
              href="https://github.com/ChemmZz/mexico-violence-in-your-lifetime" 
              target="_blank" 
              rel="noopener noreferrer"
            >
              üìÅ View Repository
            </a>
          </p>
        </div>
        
        <div class="footer-section">
          <h3>Connect</h3>
          <p>
            <a 
              href="https://github.com/ChemmZz" 
              target="_blank" 
              rel="noopener noreferrer"
            >
              üë§ GitHub
            </a>
          </p>
        </div>
      </div>
      
      <div class="footer-bottom">
        <p>Created to raise awareness about violence in Mexico ‚Ä¢ Data visualization project</p>
      </div>
    </footer>
  </body>
</html>